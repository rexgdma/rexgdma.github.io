---
title: "系统-进程、线程、协程"
layout: post
date: 2022-03-20 22:38
image: /assets/images/markdown.jpg
headerImage: false
tag:
- 进程
- 线程
- 协程

category: blog
author: rexma
description: 了解进程、线程、协程区别，以及使用场景
---

#### 进程和线程简介
  进程是资源分配的最小单元， 拥有程序控制块(PCB)包含进程信息的描述信息和控制信息，是进程存在的唯一标志。    
  线程是任务调度的最小单位，任务调度由操作系统完成， 采用时间片轮转的抢占式调度方式， 线程共享进程的地址。    
  一个标志的线程由线程ID、当前指令指针、寄存器和堆栈组成。  进程由内存空间（代码，数据，进程空间，打开的文件）和一个或多个线程组成。  
#### 进程与线程的区别
  1. 线程是程序执行的最新单元，进程是操作系统分配资源的最小单元  
  2. 一个进程是由多个线程组成  
  3. 进程之间相互独立，但统一进程下的各个线程之间共享程序的内存空间以及一些进程级的资源（打开文件，信号）   
  4. 调度和切换， 线程上下文切换比进程要快， 为什么，因为进程要切换虚拟地址，而线程不需要。 为什么虚拟地址切换慢？    
  现在我们已经知道了进程都有自己的虚拟地址空间，把虚拟地址转换为物理地址需要查找页表，页表查找是一个很慢的过程，因此通常使用Cache来缓存常用的地址映射，这样可以加速页表查找，这个cache就是TLB，Translation Lookaside Buffer，我们不需要关心这个名字只需要知道TLB本质上就是一个cache，是用来加速页表查找的。由于每个进程都有自己的虚拟地址空间，那么显然每个进程都有自己的页表，那么当进程切换后页表也要进行切换，页表切换后TLB就失效了，cache失效导致命中率降低，那么虚拟地址转换为物理地址就会变慢，表现出来的就是程序运行会变慢，而线程切换则不会导致TLB失效，因为线程线程无需切换地址空间，因此我们通常说线程切换要比较进程切换块，原因就在这里。

#### 多线程与多核
  多核(心)处理器是指在一个处理器上集成多个运算核心从而提高计算能力，也就是有多个真正并行计算的处理核心，每一个处理核心对应一个内核线程。   
  电脑双核四线程是采用超线程技术，将一个物理处理核心模拟成两个逻辑处理核心， 所以在操作系统中看到的CPU数量是实际物理CPU数量的两倍  
#### 协程
  用户管理的的用户空间线程，具有对内核来说不可见的特性。一个线程可以拥有多个协程。 协程的目的就是当出现长时间的I/  O操作时，通过让出目前的协程调度，执行下一个任务的方式，来消除ContextSwitch上的开销   
  协程特点：  
  1. 线程切换由操作系统负责，协程由用户自己调度，减少了上下文切换，提高了效率。  
  2. 线程默认stack是1M, 而协程更轻量，接近1k，  
  3. 由于在同一个线程上，因此可以避免竞争关系而使用锁  
  4. 适用被阻塞的，且需要大量并发的场景。 不适用于大量计算的多线程。  
  
  协程原理：  
  当出现IO阻塞的时候，由协程的调度器进行调度，通过将数据流立刻yield掉（主动让出），并且记录当前栈上的数据，阻塞完后立刻再通过线程恢复栈，并把阻塞的结果放到这个线程上去跑，这样看上去好像跟写同步代码没有任何差别，这整个流程可以称为coroutine，而跑在由coroutine负责调度的线程称为Fiber。比如Golang里的 go关键字其实就是负责开启一个Fiber，让func逻辑跑在上面。

#### 通过关键字go就启动了一个goroutine。我们来看一个例子
```go
package main

import (
	"fmt"
	"runtime"
)

func say(s string) {
	for i := 0; i < 5; i++ {
		runtime.Gosched()
		fmt.Println(s)
	}
}

func main() {
	go say("world") //开一个新的Goroutines执行
	say("hello") //当前Goroutines执行
}

// 以上程序执行后将输出：
// hello
// world
// hello
// world
// hello
// world
// hello
// world
// hello
```
我们可以看到go关键字很方便的就实现了并发编程。 上面的多个goroutine运行在同一个进程里面，共享内存数据，不过设计上我们要遵循：不要通过共享来通信，而要通过通信来共享。


